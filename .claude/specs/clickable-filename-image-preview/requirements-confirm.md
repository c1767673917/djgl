# 需求确认文档：管理界面可点击文件名图片预览功能

## 📝 原始需求
**用户请求**: 在管理界面中，文件名添加可点击特性，点击后显示这张图片

**功能名称**: clickable-filename-image-preview
**创建时间**: 2025-10-20
**工作流**: requirements-pilot

---

## 🏗️ 代码库上下文影响

### 现有系统架构
- **管理页面**: `static/admin.html` (原生JavaScript + 响应式设计)
- **图片存储**: 本地 `upload_images/` 目录
- **API端点**: `/api/admin/records` (提供上传记录列表)
- **数据模型**: `UploadRecord` (包含 `filename`, `file_path`, `local_backup_path` 字段)
- **UI风格**: 暗色主题、响应式布局、无外部UI库依赖

### 技术约束
- ✅ 纯JavaScript实现（无jQuery、Vue等框架）
- ✅ 静态文件服务已配置 (`app.mount("/upload_images", StaticFiles(...))`)
- ✅ 现有代码风格：模块化函数、ES6语法、async/await
- ⚠️ 桌面浏览器优先（移动端非重点）

### 集成点
1. **前端修改**: `static/admin.html` - 添加模态框HTML、点击事件、图片预览逻辑
2. **后端修改**: 无需修改（图片已通过静态文件服务暴露）
3. **样式修改**: `static/admin.html` 内联CSS - 添加模态框样式
4. **测试修改**: 无需添加后端测试，可选添加前端集成测试

---

## 🔄 需求澄清过程

### 第1轮澄清（质量分数：55/100）

#### 提出的问题
1. **交互设计**: 图片显示方式？关闭方式？
2. **技术实现**: 图片来源（本地/云端）？缩放功能？
3. **边界场景**: 加载失败处理？加载状态？
4. **业务上下文**: 使用场景？移动端支持？

#### 用户反馈（2025-10-20）

| 问题 | 用户选择 | 详细说明 |
|------|---------|---------|
| Q1: 显示方式 | **模态框（Modal）** | 在当前页面弹出对话框显示图片 |
| Q2: 关闭方式 | **点击外部区域关闭** | 点击模态框外部区域即可关闭 |
| Q3: 图片来源 | **本地 upload_images/ 目录** | 使用当前上传文件存储位置的图片 |
| Q4: 缩放功能 | **支持鼠标滚轮缩放 + 旋转** | 支持滚轮缩放、缩放按钮、顺时针/逆时针旋转 |
| Q5: 加载失败 | **显示"图片加载失败"提示** | 明确的错误信息提示 |
| Q6: 加载状态 | **显示加载动画（旋转圈）** | 提供视觉反馈 |
| Q7: 使用场景 | **查看单据详情** | 在不离开管理页面的情况下查看单据详情 |
| Q8: 移动端 | **仅桌面浏览器** | 不需要特别优化移动端体验 |

---

## ✅ 最终确认需求

### 功能概述
在管理后台页面（`static/admin.html`）的上传记录列表中，为文件名添加可点击特性。点击后弹出模态框，展示对应的上传图片，支持缩放、旋转等图片查看操作。

### 详细功能规格

#### 1. 交互设计

##### 1.1 文件名可点击状态
- **视觉样式**:
  - 鼠标悬停时：文件名变为蓝色，显示下划线，鼠标变为手型指针
  - 普通状态：保持当前样式
- **点击行为**: 点击文件名触发图片预览模态框

##### 1.2 模态框布局
- **组件结构**:
  ```
  模态框遮罩层（半透明黑色背景）
  └── 模态框容器
      ├── 关闭按钮（×）
      ├── 工具栏
      │   ├── 放大按钮（+）
      │   ├── 缩小按钮（-）
      │   ├── 顺时针旋转按钮（↻）
      │   └── 逆时针旋转按钮（↺）
      ├── 图片容器
      │   ├── 加载动画（加载中时显示）
      │   ├── 图片元素（加载成功后显示）
      │   └── 错误提示（加载失败时显示）
      └── 文件名标题栏
  ```

- **尺寸和定位**:
  - 模态框最大宽度：90vw
  - 模态框最大高度：90vh
  - 垂直和水平居中显示
  - 图片自适应容器大小（保持纵横比）

##### 1.3 关闭方式
- **方式1**: 点击模态框外部区域（遮罩层）关闭
- **方式2**: 点击关闭按钮（×）
- **可选扩展**: 按ESC键关闭（建议实现）

#### 2. 图片操作功能

##### 2.1 缩放功能
- **鼠标滚轮缩放**:
  - 向上滚动：放大（每次增加10%）
  - 向下滚动：缩小（每次减少10%）
  - 缩放范围：10% - 500%

- **按钮缩放**:
  - 放大按钮（+）：每次增加20%
  - 缩小按钮（-）：每次减少20%
  - 显示当前缩放比例（如 "100%"）

##### 2.2 旋转功能
- **顺时针旋转按钮（↻）**: 每次旋转90度
- **逆时针旋转按钮（↺）**: 每次旋转-90度
- **旋转状态**: 0°, 90°, 180°, 270°循环

##### 2.3 重置功能
- **可选**: 提供"重置"按钮，恢复到原始尺寸和0°旋转

#### 3. 技术实现

##### 3.1 图片路径构建
- **逻辑**:
  ```javascript
  // record.filename 示例: "240001_1.jpg"
  const imageUrl = `/upload_images/${record.filename}`;
  ```
- **静态文件服务**: 已由FastAPI配置，无需修改后端

##### 3.2 加载状态处理
- **加载中**:
  - 显示旋转加载动画（使用CSS @keyframes）
  - 显示提示文字："加载中..."
  - 禁用工具栏按钮

- **加载成功**:
  - 隐藏加载动画
  - 显示图片
  - 启用工具栏按钮

- **加载失败**:
  - 隐藏加载动画
  - 显示错误图标和提示文字："图片加载失败"
  - 提供原因提示（如文件不存在）
  - 禁用工具栏按钮

##### 3.3 图片加载实现
```javascript
const img = new Image();
img.onload = () => {
    // 显示图片，隐藏加载动画
};
img.onerror = () => {
    // 显示错误提示
};
img.src = imageUrl;
```

#### 4. 样式设计

##### 4.1 模态框样式
- **遮罩层**:
  - 背景：`rgba(0, 0, 0, 0.8)`
  - z-index: 1000
  - 覆盖整个视口

- **模态框容器**:
  - 背景：`#2b2b2b`（与现有暗色主题一致）
  - 边框：`1px solid #444`
  - 圆角：`8px`
  - 阴影：`0 4px 20px rgba(0, 0, 0, 0.5)`

- **关闭按钮**:
  - 位置：右上角
  - 大小：30px × 30px
  - 颜色：`#ccc`，悬停时 `#fff`

##### 4.2 工具栏样式
- **布局**: 水平排列，居中显示
- **按钮**:
  - 尺寸：40px × 40px
  - 背景：`#444`，悬停时 `#555`
  - 图标：使用Unicode符号（+、-、↻、↺）或SVG
  - 间距：8px

##### 4.3 图片容器样式
- **最大尺寸**: 80vh × 80vw
- **背景**: 棋盘格背景（用于透明图片）
- **overflow**: hidden
- **居中显示**: flex布局

#### 5. 边界场景处理

##### 5.1 文件不存在
- **检测**: `img.onerror` 触发
- **显示**: "图片加载失败：文件不存在"
- **操作**: 禁用所有工具栏按钮

##### 5.2 网络错误
- **检测**: `img.onerror` 触发
- **显示**: "图片加载失败：网络错误"

##### 5.3 文件格式不支持
- **检测**: `img.onerror` 触发
- **显示**: "图片加载失败：文件格式不支持"

##### 5.4 图片过大
- **处理**: 自动缩放以适应容器
- **初始显示**: 适应窗口大小（contain模式）

##### 5.5 缩放极限
- **最小缩放**: 10%（防止图片消失）
- **最大缩放**: 500%（防止性能问题）
- **到达极限**: 禁用对应按钮或显示提示

#### 6. 用户体验细节

##### 6.1 性能优化
- **懒加载**: 仅在点击时加载图片
- **事件委托**: 使用事件委托减少事件监听器
- **防抖**: 鼠标滚轮缩放添加防抖（100ms）

##### 6.2 可访问性
- **键盘支持**: ESC键关闭（可选）
- **焦点管理**: 打开模态框时聚焦到关闭按钮
- **ARIA标签**: 添加 `aria-label` 描述

##### 6.3 动画效果
- **淡入效果**: 模态框打开时0.3s淡入
- **淡出效果**: 关闭时0.2s淡出
- **平滑过渡**: 缩放和旋转使用CSS transition

---

## 📊 需求质量评分（第2轮）

| 评分项 | 得分 | 满分 | 说明 |
|--------|------|------|------|
| **功能清晰度** | **28** | 30 | ✅ 交互方式、显示形式、关闭方式、操作功能全部明确 |
| **技术具体性** | **23** | 25 | ✅ 图片来源、实现路径、技术栈、浏览器支持清晰 |
| **实现完整性** | **23** | 25 | ✅ 错误处理、加载状态、边界场景、性能优化覆盖全面 |
| **业务上下文** | **19** | 20 | ✅ 使用场景明确、用户价值清晰、优先级合理 |

### 🎯 最终质量分数: **93/100** ✅

**质量等级**: 优秀（≥90分）

**达成标准**:
- ✅ 功能需求完整且具体
- ✅ 技术实现路径清晰
- ✅ 边界场景处理全面
- ✅ 业务价值明确

---

## 🎯 需求摘要

### 核心功能
在管理后台的上传记录列表中，点击文件名弹出图片预览模态框，支持缩放、旋转等操作。

### 关键特性
1. **模态框预览**: 弹出式对话框展示图片
2. **缩放功能**: 鼠标滚轮 + 按钮控制（10%-500%）
3. **旋转功能**: 顺时针/逆时针旋转90度
4. **加载反馈**: 加载动画 + 错误提示
5. **关闭方式**: 点击外部区域关闭

### 技术方案
- **实现方式**: 纯JavaScript（无外部依赖）
- **图片来源**: 本地 `upload_images/` 目录
- **集成点**: `static/admin.html` 前端修改
- **样式风格**: 与现有暗色主题一致

### 用户价值
方便管理员在不离开列表页的情况下快速查看上传的单据图片内容，提升工作效率。

---

## 📋 实施准备

### 修改文件清单
- ✅ `static/admin.html` - 添加模态框HTML、CSS、JavaScript逻辑
- ✅ 无需后端修改（静态文件服务已配置）

### 预计工作量
- **开发**: 约100-150行代码（HTML + CSS + JavaScript）
- **测试**: 手动测试各项功能（加载、缩放、旋转、错误处理）
- **总时间**: 约1-2小时

### 依赖项
- ✅ 无新增依赖
- ✅ 使用现有技术栈

---

## ✅ 需求确认完成

**确认时间**: 2025-10-20
**确认状态**: 已达到90+质量标准，等待用户批准实施

**下一步**: 等待用户明确批准后，启动实施阶段（Phase 2）
