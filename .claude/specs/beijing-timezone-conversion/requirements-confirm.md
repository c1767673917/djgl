# 北京时区转换需求确认文档

## 原始需求
项目中所有涉及时间的都改为北京时间

## 仓库上下文影响
基于仓库扫描结果，项目为 FastAPI + SQLite + JavaScript 单据上传管理系统。
当前时间处理：
- 数据库：UTC 时间 (CURRENT_TIMESTAMP)
- 后端：naive datetime (datetime.now())
- 前端：浏览器本地时区

## 需求确认轮次

### 第一轮澄清（质量评分：59/100）
**提出的问题**：
1. 时区转换策略（数据库存储 UTC vs 北京时间）
2. 前端显示格式
3. API 响应时间格式
4. 历史数据和外部 API 处理
5. 测试覆盖需求

**用户反馈**：
1. ✅ 直接在数据库中存储北京时间
2. ✅ 时间格式：`2025-10-15 14:30:45`，不需要标注时区
3. ✅ API 响应格式由实施方决定
4. ✅ 已存在数据直接清除，无需迁移；用友云 API 返回时间不做处理
5. ✅ 无需单元测试

## 最终确认需求

### 功能需求

#### 1. 数据库层改造
- **策略**：直接存储北京时间（UTC+8）
- **影响字段**：
  - `upload_history.upload_time`
  - `upload_history.created_at`
  - `upload_history.updated_at`
  - `upload_history.deleted_at`
- **数据处理**：清空现有历史数据（重新开始）

#### 2. 后端应用层改造
- **修改位置**：
  - `app/models/upload_history.py:30` - 上传时间初始化
  - `app/api/admin.py:174` - 导出时间戳
  - `app/api/admin.py:323` - 软删除时间
- **实现方式**：
  - 创建统一的北京时间工具函数
  - 替换所有 `datetime.now()` 为北京时间版本
  - 确保 async/await 架构兼容

#### 3. 前端显示层改造
- **修改位置**：
  - `app/static/js/admin.js:263-272` - 管理页面时间显示
  - `app/static/js/app.js:362` - 上传页面时间显示
- **显示格式**：`2025-10-15 14:30:45`
- **无需标注**：不显示"(北京时间)"等后缀

#### 4. API 响应格式
- **决策**：返回 ISO 8601 格式的北京时间字符串
- **格式示例**：`2025-10-15T14:30:45`（不含时区标识）
- **理由**：
  - 前端易于解析
  - 保持与数据库存储一致
  - 避免时区混淆

### 技术规格

#### 时间工具函数设计
```python
# app/core/utils.py 或 app/core/timezone.py
from datetime import datetime, timezone, timedelta

BEIJING_TZ = timezone(timedelta(hours=8))

def get_beijing_now() -> datetime:
    """获取当前北京时间（带时区信息）"""
    return datetime.now(BEIJING_TZ)

def get_beijing_now_naive() -> datetime:
    """获取当前北京时间（无时区信息，用于数据库存储）"""
    return datetime.now(BEIJING_TZ).replace(tzinfo=None)
```

#### 数据库模型改造
- 使用 `get_beijing_now_naive()` 替代 `datetime.now()`
- 移除 SQLite 的 `CURRENT_TIMESTAMP` 依赖
- 应用层完全控制时间生成

#### 前端格式化函数
```javascript
// 标准化时间显示格式
function formatBeijingTime(timeStr) {
    if (!timeStr) return '-';
    // 假设后端返回 ISO 格式或标准格式
    return timeStr.replace('T', ' ').substring(0, 19);
}
```

### 边界情况处理

#### 1. 历史数据清除
- **操作**：执行 `DELETE FROM upload_history WHERE 1=1`
- **影响**：所有上传记录将被清除
- **备份**：建议用户自行决定是否备份

#### 2. 用友云 API 时间
- **策略**：保持原样，不做转换
- **理由**：外部系统时间仅用于 token 过期判断，无需展示

#### 3. 跨时区兼容性
- **当前范围**：仅支持北京时间
- **未来扩展**：如需多时区支持，需重构为 timezone-aware 架构

### 实施范围

#### 包含项
✅ 后端时间生成逻辑改造（8个文件中的4个关键位置）
✅ 前端时间显示格式统一（2个 JavaScript 文件）
✅ 数据库历史数据清除
✅ API 响应格式标准化

#### 排除项
❌ 单元测试编写
❌ 历史数据迁移
❌ 用友云 API 时间转换
❌ CI/CD 流程配置

### 成功标准

1. **功能正确性**：
   - 所有新创建的记录显示北京时间
   - 时间格式统一为 `YYYY-MM-DD HH:MM:SS`
   - 前后端时间一致

2. **集成质量**：
   - 与现有异步架构无缝集成
   - 不影响用友云 API 调用
   - 软删除功能正常

3. **代码质量**：
   - 遵循现有代码风格
   - 统一使用时间工具函数
   - 避免硬编码时区偏移

### 质量评分（第二轮）

| 评分项 | 得分 | 满分 | 说明 |
|--------|------|------|------|
| 功能清晰度 | 28 | 30 | 明确输入输出、时间格式、成功标准 |
| 技术具体性 | 24 | 25 | 详细的技术方案、集成点、约束条件 |
| 实现完整性 | 23 | 25 | 覆盖边界情况、数据清除、格式统一 |
| 业务上下文 | 18 | 20 | 明确优先级、实施范围、用户价值 |
| **总分** | **93** | **100** | ✅ 达到实施标准 |

## 需求质量达标 ✅

需求清晰度已达到 **93/100 分**，满足实施标准（≥90分）。
所有关键决策点已明确，技术方案具体可行，可以进入实施阶段。

---

**文档生成时间**：2025-10-15
**需求确认版本**：v1.0
**批准状态**：待用户最终确认
