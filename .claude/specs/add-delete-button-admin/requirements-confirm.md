# 需求确认文档 - 后台管理页面添加删除功能

## 原始需求
后台管理页面中，增加记录删除按钮，仅删除本地记录，和用友系统无关

## 仓库上下文影响

### 现有系统架构
- **后端框架**: FastAPI + SQLite
- **前端技术**: 原生HTML/CSS/JavaScript (ES6+)
- **管理页面**: `app/static/admin.html` + `app/static/js/admin.js`
- **API模块**: `app/api/admin.py`
- **数据库表**: `upload_history` (19个字段)

### 集成点
1. **后端API**: 在 `app/api/admin.py` 添加删除端点
2. **前端页面**: 在 `app/static/admin.html` 表格中添加操作列
3. **前端逻辑**: 在 `app/static/js/admin.js` 实现删除功能

## 需求澄清过程

### 第一轮澄清 (2025-10-03)

#### 提问的问题
1. **删除确认机制**: 是否需要二次确认？是否支持批量删除？
2. **删除策略**: 硬删除还是软删除？
3. **文件处理**: 是否删除本地文件？文件删除失败如何处理？
4. **权限控制**: 是否需要管理员权限？是否记录删除日志？
5. **用户体验**: 按钮位置？成功反馈方式？

#### 用户回答
1. ✅ 需要二次对话确认，支持批量删除
2. ✅ 软删除（标记deleted_at字段，保留数据）
3. ✅ **不删除本地文件**
4. ✅ 所有用户都能删除记录，不需要日志
5. ✅ 每行最右侧的操作列，显示成功提示并自动刷新列表

## 最终确认需求

### 功能描述
在后台管理页面添加记录删除功能，采用软删除策略，仅标记数据库记录，不删除本地文件，不影响用友系统。

### 详细规格

#### 1. 功能范围 (30/30分)
**核心功能**:
- 单条记录删除：每行最右侧添加"删除"按钮
- 批量删除：支持勾选多条记录后批量删除
- 软删除策略：标记 `deleted_at` 字段，不物理删除数据
- 本地文件保留：不删除 `uploads/` 目录下的文件

**用户交互流程**:
1. 用户点击删除按钮（单条）或批量删除按钮
2. 弹出二次确认对话框，显示即将删除的记录数量
3. 用户确认后，调用后端API执行软删除
4. 显示成功提示消息
5. 自动刷新记录列表

**成功标准**:
- 删除后记录在列表中不可见
- 数据库中记录的 `deleted_at` 字段被设置为当前时间戳
- 本地文件完整保留在 `uploads/` 目录
- 不调用任何用友云API

#### 2. 技术规格 (25/25分)

**数据库变更**:
```sql
-- 添加软删除字段（如果不存在）
ALTER TABLE upload_history ADD COLUMN deleted_at TEXT DEFAULT NULL;

-- 创建索引优化查询性能
CREATE INDEX IF NOT EXISTS idx_deleted_at ON upload_history(deleted_at);
```

**后端API规格**:
```python
# 端点: DELETE /api/admin/records
# 请求参数:
{
    "ids": [1, 2, 3]  # 要删除的记录ID列表
}

# 响应格式:
{
    "success": true,
    "deleted_count": 3,
    "message": "成功删除3条记录"
}
```

**前端UI变更**:
- 表格添加"操作"列，包含"删除"按钮
- 表格头部添加"批量删除"按钮（仅在有勾选时显示）
- 每行添加复选框用于批量选择
- 使用原生 `confirm()` 对话框进行二次确认

**集成约束**:
- 遵循现有代码风格（PEP 8, ES6+）
- 使用现有的 `fetch()` API调用方式
- 保持现有的错误处理模式
- 兼容现有的分页和筛选功能

#### 3. 实现完整性 (25/25分)

**边界情况处理**:
1. **空选择**: 批量删除时未勾选任何记录 → 提示"请至少选择一条记录"
2. **重复删除**: 删除已删除的记录 → 后端忽略，不报错
3. **并发删除**: 多用户同时删除同一记录 → 幂等性设计，以最后操作为准
4. **网络错误**: API调用失败 → 显示错误提示，不刷新列表
5. **部分成功**: 批量删除时部分ID不存在 → 返回实际删除数量

**错误处理**:
```javascript
// 前端错误处理示例
try {
    const response = await fetch('/api/admin/records', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: selectedIds})
    });

    if (!response.ok) {
        throw new Error('删除失败');
    }

    const result = await response.json();
    alert(`成功删除${result.deleted_count}条记录`);
    loadRecords(); // 刷新列表
} catch (error) {
    alert('删除失败: ' + error.message);
}
```

**数据验证**:
- 后端验证 `ids` 参数为非空数组
- 后端验证所有ID为正整数
- 前端验证至少选择一条记录

**查询逻辑调整**:
- 所有查询添加 `WHERE deleted_at IS NULL` 条件
- 确保软删除的记录不在列表中显示
- 保持现有的分页、排序、筛选功能正常工作

#### 4. 业务上下文 (20/20分)

**用户价值**:
- 管理员可清理错误上传、测试数据
- 避免误删导致数据丢失（软删除可恢复）
- 保留本地文件便于后续审计或恢复
- 不影响用友系统的数据一致性

**优先级定义**:
- **核心功能**: 单条删除 + 软删除实现（P0）
- **次要功能**: 批量删除（P1）
- **可选功能**: 恢复已删除记录（未包含在此需求中）

**非功能性需求**:
- 无需管理员认证（当前系统无认证机制）
- 无需操作日志（用户明确不需要）
- 性能要求：批量删除≤100条记录，响应时间<2秒

**约束条件**:
- 不调用用友云API
- 不删除本地文件系统的文件
- 保持现有数据库架构兼容性

## 需求质量评分

### 最终得分: **100/100**

- ✅ **功能清晰度**: 30/30分
  - 明确的用户交互流程
  - 清晰的输入输出规格
  - 具体的成功标准

- ✅ **技术规范**: 25/25分
  - 详细的数据库变更方案
  - 明确的API接口设计
  - 具体的技术约束

- ✅ **实现完整性**: 25/25分
  - 完整的边界情况覆盖
  - 详细的错误处理策略
  - 明确的数据验证规则

- ✅ **业务上下文**: 20/20分
  - 清晰的用户价值定位
  - 明确的优先级划分
  - 具体的非功能性需求

## 实现建议

### 推荐开发顺序
1. **数据库迁移**: 添加 `deleted_at` 字段和索引
2. **后端API**: 实现 `DELETE /api/admin/records` 端点
3. **查询逻辑**: 修改现有查询添加软删除过滤
4. **前端UI**: 添加删除按钮和复选框
5. **前端逻辑**: 实现删除功能和二次确认
6. **测试**: 单元测试 + 手动测试

### 预期工作量
- **数据库迁移**: 10分钟
- **后端开发**: 30分钟
- **前端开发**: 40分钟
- **测试和调试**: 20分钟
- **总计**: 约1.5-2小时

## 附录

### 相关文件清单
- `app/api/admin.py` - 后端API端点
- `app/static/admin.html` - 管理页面HTML
- `app/static/js/admin.js` - 前端交互逻辑
- `app/database.py` - 数据库初始化（可能需要添加迁移逻辑）
- `app/models/database.py` - 数据库操作封装

### 参考现有代码模式
- API响应格式参考: `app/api/admin.py:get_records()`
- 前端fetch调用参考: `app/static/js/admin.js:loadRecords()`
- 错误处理参考: `app/static/js/admin.js` 全局错误处理

---

**文档版本**: 1.0
**创建时间**: 2025-10-03
**需求状态**: ✅ 已确认，等待用户批准实现
