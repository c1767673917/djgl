# WebDAV集成与数据库备份需求确认文档

## 需求质量评分：92/100 ✅

**项目背景**：单据上传管理系统存储空间有限，需要使用WebDAV完全替代本地存储，并实现数据库定时备份。

---

## 一、原始需求

**用户需求**：由于服务储存空间有限，储存图片压力巨大，我希望使用webdav来完全替代本地储存,同时每天0点备份数据库

---

## 二、仓库上下文影响

### 现有技术栈
- **后端框架**：FastAPI 0.104.1
- **数据库**：SQLite
- **异步支持**：httpx异步客户端
- **配置管理**：Pydantic Settings + .env

### 现有架构特点
- 分层架构（API层 → 核心层 → 数据层）
- 完整的异步编程模式
- 企业级错误处理和重试机制
- 模块化设计便于扩展

### WebDAV服务配置
- 服务器地址：`http://localhost:10100/dav/`
- 认证信息：`admin` / `adminlcs`
- 目标存储目录：`onedrive_lcs/`

---

## 三、需求确认过程

### 第一轮澄清（分数：75/100）
**提出的关键问题**：
1. 文件访问策略？
2. 现有文件处理方式？
3. 备份策略细节？
4. WebDAV故障处理机制？

**用户回答**：
1. 混合模式：常用文件缓存，其他文件从WebDAV实时获取
2. 批量迁移到WebDAV
3. 备份数据库+关键配置文件
4. 降级到本地临时存储，恢复后同步

### 第二轮澄清（分数：85/100）
**提出的技术细节问题**：
1. 缓存策略细节（判断标准、清理策略）
2. 批量迁移执行方式
3. 数据库备份配置（命名、保留策略、配置文件）
4. 同步机制细节（触发方式、失败处理）
5. 性能要求

**用户回答**：
1. **缓存策略**：7天内上传的文件保留缓存，超过7天删除
2. **迁移方式**：管理后台添加"迁移到WebDAV"按钮，并显示进度
3. **备份配置**：
   - 文件命名：`backup_YYYYMMDD_HHMMSS.tar.gz`
   - 保留最近30天
   - 包含：SQLite数据库 + .env配置文件
4. **同步机制**：
   - 实时检测WebDAV可用性，自动同步
   - 持续重试直到成功
5. **性能要求**：首次加载<2秒，缓存命中<1秒

---

## 四、最终确认需求规范

### 功能需求（30/30分）

#### 4.1 WebDAV文件存储集成
1. **文件上传**：所有新上传的图片文件直接存储到WebDAV
   - 上传接口：`PUT http://localhost:10100/dav/onedrive_lcs/files/{filename}`
   - 认证方式：Basic Auth (admin:adminlcs)
   - 支持中文文件名（自动URL编码）
   - 成功返回：200/201状态码

2. **混合缓存机制**：
   - **缓存策略**：7天内上传的文件在本地保留缓存副本
   - **缓存路径**：`./cache/` 目录，保持原有目录结构
   - **自动清理**：每日凌晨检查并删除超过7天的缓存文件
   - **缓存写入时机**：文件上传到WebDAV成功后，同步写入本地缓存

3. **文件访问**：
   - **缓存命中**：直接返回本地缓存文件（性能目标：<1秒）
   - **缓存未命中**：从WebDAV实时下载（性能目标：<2秒）
   - **下载接口**：`GET http://localhost:10100/dav/onedrive_lcs/files/{filename}`
   - **下载后处理**：如文件在7天内，写入本地缓存

4. **文件迁移功能**：
   - **触发方式**：管理后台新增"迁移到WebDAV"按钮
   - **迁移范围**：所有现有本地存储的图片文件
   - **进度显示**：实时显示迁移进度（已完成/总数量、百分比）
   - **迁移策略**：
     - 扫描本地存储目录
     - 逐个上传到WebDAV对应路径
     - 上传成功后验证文件完整性
     - 验证通过后删除本地原文件
     - 记录迁移日志（成功/失败）
   - **错误处理**：单个文件失败不中断，记录错误继续下一个

#### 4.2 WebDAV故障容错机制
1. **健康检查**：
   - 每60秒检测一次WebDAV服务可用性
   - 检测方法：HEAD请求根目录
   - 维护服务状态标识（可用/不可用）

2. **降级存储**：
   - WebDAV不可用时，文件临时存储到 `./temp_storage/` 目录
   - 记录待同步文件清单到 `pending_sync.json`
   - 前端展示WebDAV状态告警

3. **自动同步**：
   - WebDAV恢复可用后，自动触发同步任务
   - 读取 `pending_sync.json` 文件清单
   - 逐个上传文件到WebDAV
   - **持续重试机制**：失败后等待5分钟重试，直到成功
   - 同步成功后删除临时文件，更新清单

#### 4.3 数据库定时备份
1. **备份调度**：
   - 执行时间：每天凌晨0点
   - 调度框架：APScheduler（已有依赖）
   - 备份任务异步执行，不阻塞主服务

2. **备份内容**：
   - SQLite数据库文件：`data.db`
   - 环境配置文件：`.env`
   - 打包格式：tar.gz压缩包

3. **备份文件命名**：
   - 格式：`backup_YYYYMMDD_HHMMSS.tar.gz`
   - 示例：`backup_20251027_000000.tar.gz`

4. **备份存储**：
   - 目标位置：WebDAV `/onedrive_lcs/backups/` 目录
   - 上传方式：使用WebDAV客户端上传

5. **备份清理**：
   - 保留策略：保留最近30天的备份文件
   - 清理时机：每次备份完成后检查并清理过期文件
   - 清理方法：列出目录，解析文件名时间戳，删除30天前的文件

6. **备份监控**：
   - 记录备份执行日志（开始时间、结束时间、文件大小、状态）
   - 失败时记录错误信息，发送告警日志
   - 成功时更新最后备份时间

---

### 技术细节（25/25分）

#### 技术实现方案
1. **WebDAV客户端库**：使用 `httpx` 异步客户端实现WebDAV协议
   - PROPFIND：列出目录文件
   - GET：下载文件
   - PUT：上传文件
   - DELETE：删除文件
   - MKCOL：创建目录

2. **配置管理**：扩展现有 `Settings` 类
   ```python
   # 新增配置项
   WEBDAV_URL: str = "http://localhost:10100/dav/"
   WEBDAV_USERNAME: str = "admin"
   WEBDAV_PASSWORD: str = "adminlcs"
   WEBDAV_BASE_PATH: str = "onedrive_lcs"
   CACHE_DIR: str = "./cache"
   CACHE_DAYS: int = 7
   TEMP_STORAGE_DIR: str = "./temp_storage"
   BACKUP_RETENTION_DAYS: int = 30
   ```

3. **文件路径映射**：
   - 本地路径：`./uploads/2025/10/27/image.jpg`
   - WebDAV路径：`/dav/onedrive_lcs/files/2025/10/27/image.jpg`
   - 缓存路径：`./cache/2025/10/27/image.jpg`

4. **异步任务调度**：
   - 定时备份：APScheduler CronTrigger
   - 缓存清理：APScheduler IntervalTrigger（每日执行）
   - WebDAV健康检查：APScheduler IntervalTrigger（60秒间隔）

5. **数据库扩展**：新增表记录文件元数据
   ```sql
   CREATE TABLE file_metadata (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       filename TEXT NOT NULL,
       webdav_path TEXT NOT NULL,
       local_cache_path TEXT,
       upload_time DATETIME NOT NULL,
       file_size INTEGER NOT NULL,
       is_cached BOOLEAN DEFAULT 1,
       last_access_time DATETIME
   );
   ```

#### 性能指标
- **文件上传**：WebDAV上传 + 本地缓存写入并行执行
- **文件下载（缓存命中）**：<1秒
- **文件下载（缓存未命中）**：<2秒
- **缓存清理**：非高峰期执行，不影响业务

#### 集成点
- **上传API修改**：`app/api/upload.py` - 替换本地存储为WebDAV
- **文件服务修改**：`app/core/file_service.py` - 添加缓存查询逻辑
- **管理后台扩展**：`static/admin.html` - 添加迁移功能按钮
- **定时任务新增**：`app/scheduler.py` - 添加备份和缓存清理任务

---

### 实现完整性（25/25分）

#### 边界情况处理
1. **WebDAV连接失败**：
   - 上传时失败 → 降级到临时存储 + 记录待同步清单
   - 下载时失败 → 返回404，记录错误日志
   - 健康检查失败 → 更新服务状态，触发告警

2. **文件名冲突**：
   - 使用时间戳 + UUID生成唯一文件名
   - 示例：`20251027_123456_a1b2c3d4.jpg`

3. **中文文件名处理**：
   - 自动进行URL编码（urllib.parse.quote）
   - 解码时使用unquote恢复原文件名

4. **大文件上传**：
   - 启用httpx超时配置（timeout=300秒）
   - 支持流式上传，避免内存溢出

5. **磁盘空间不足**：
   - 缓存写入前检查磁盘空间
   - 空间不足时仅使用WebDAV，不写缓存

6. **备份文件损坏**：
   - 备份完成后校验压缩包完整性
   - 校验失败时重新备份

#### 错误处理策略
1. **WebDAV API调用**：
   - 网络超时：3次重试，间隔5秒
   - 认证失败：记录错误，不重试
   - 服务器错误（5xx）：3次重试，间隔10秒

2. **文件迁移**：
   - 单个文件失败不中断整体流程
   - 记录失败文件清单到 `migration_errors.log`
   - 前端显示失败数量

3. **备份任务**：
   - 失败时记录详细错误信息
   - 不阻塞下次定时备份
   - 连续失败3次发送告警

#### 数据验证
1. **文件完整性**：
   - 上传后验证文件大小是否一致
   - 支持可选的MD5校验

2. **备份文件校验**：
   - 压缩包完整性检查（tar -tzf）
   - 文件大小合理性检查（>1KB）

3. **配置验证**：
   - 启动时检查WebDAV连接可用性
   - 配置缺失时给出明确提示

#### 日志记录
- **WebDAV操作日志**：记录所有API调用（URL、状态码、耗时）
- **迁移日志**：记录迁移进度和结果
- **备份日志**：记录备份执行情况
- **同步日志**：记录临时文件同步状态

---

### 业务价值（20/20分）

#### 问题解决
1. **存储空间释放**：将图片文件转移到WebDAV，释放服务器本地存储空间
2. **扩展性提升**：WebDAV支持海量存储，解决存储扩展瓶颈
3. **数据安全保障**：每日自动备份，防止数据丢失
4. **高可用性**：故障容错机制确保服务连续性

#### 用户价值
1. **透明迁移**：用户无感知的文件存储切换
2. **性能保证**：缓存机制确保常用文件快速访问
3. **运维便利**：自动化备份，无需人工干预

#### 优先级定义
- **P0（最高优先级）**：WebDAV文件上传下载、故障降级
- **P1（高优先级）**：混合缓存机制、数据库备份
- **P2（中优先级）**：文件迁移功能、备份清理
- **P3（低优先级）**：备份监控、性能优化

---

## 五、技术风险与应对

### 潜在风险
1. **WebDAV服务稳定性**：依赖外部服务，可能出现不可用
   - **应对**：故障降级机制 + 自动同步

2. **网络延迟**：WebDAV访问受网络影响
   - **应对**：混合缓存机制，热数据本地访问

3. **数据一致性**：降级期间可能出现本地和WebDAV不一致
   - **应对**：待同步清单 + 持续重试机制

4. **迁移时间较长**：大量文件迁移可能耗时较久
   - **应对**：异步执行 + 进度显示 + 支持中断续传

### 性能考量
- **并发控制**：限制同时上传/下载的并发数（如：最多5个）
- **缓存命中率**：预计7天内文件占80%访问，缓存命中率80%+
- **备份压缩比**：预计压缩后体积为原始数据的30%-50%

---

## 六、验收标准

### 功能验收
- [ ] 新上传的文件成功存储到WebDAV
- [ ] 文件下载正常（缓存命中和未命中场景）
- [ ] 缓存文件在7天后自动清理
- [ ] 管理后台迁移功能正常，进度显示准确
- [ ] 迁移完成后原文件已删除，WebDAV可访问
- [ ] WebDAV不可用时降级到本地存储
- [ ] WebDAV恢复后自动同步临时文件
- [ ] 每日凌晨0点自动执行备份
- [ ] 备份文件包含数据库和.env文件
- [ ] 自动清理30天前的备份文件

### 性能验收
- [ ] 缓存文件访问延迟 <1秒
- [ ] WebDAV文件首次访问延迟 <2秒
- [ ] 文件上传成功率 >99%
- [ ] 备份任务执行时间 <5分钟

### 兼容性验收
- [ ] 与现有上传功能兼容
- [ ] 与现有文件访问接口兼容
- [ ] 数据库迁移平滑，无数据丢失

---

## 七、实施计划建议

### 阶段1：WebDAV核心功能（P0）
1. WebDAV客户端封装
2. 文件上传/下载接口集成
3. 故障降级机制

### 阶段2：缓存与备份（P1）
1. 混合缓存机制实现
2. 定时备份任务
3. 缓存自动清理

### 阶段3：迁移与监控（P2-P3）
1. 文件迁移功能
2. 备份文件清理
3. 日志与监控完善

---

## 八、确认签字

**需求分析师**：Claude Code Agent
**需求确认时间**：2025-10-27
**需求质量评分**：92/100 ✅

**评分明细**：
- 功能清晰度：30/30
- 技术细节：25/25
- 实现完整性：25/25
- 业务价值：20/20
- 扣分项：风险应对可进一步细化（-8分）

---

**状态**：✅ 需求已达到90+质量标准，可以进入实施阶段
