# 需求确认文档 - 图片二维码验证功能

## 原始需求
用户可能扫码了这张单据的二维码,但是上传的图片属于其他单据,因此我要求用户上传上传的图片包含二维码,扫码后同样能获取到上传链接,上传图片时识别图片中的二维码,与当前页面的链接做对比,扫码不出二维码或者链接不一致的提示它是否上传。

## 代码库上下文影响
- **现有技术栈**: FastAPI后端 + 原生JavaScript前端
- **现有上传流程**: 多选图片 → 预览 → 点击上传按钮 → 后端批量上传到用友云
- **URL格式**: `http://192.168.1.4:10000/{business_id}` (business_id为纯数字)
- **无现有二维码处理**: 需新增前端二维码识别库

## 需求澄清过程

### 第一轮澄清 (2025-10-03)

**问题1: 验证时机**
- ✅ **确认**: 前端上传前验证
- **原因**: 用户体验更好,避免上传后才发现错误

**问题2: 不匹配时的行为**
- ✅ **确认**: 弹窗警告,用户可选择"仍然上传"或"重新拍照"
- **原因**: 平衡安全性与灵活性,避免误拦截正常上传

**问题3: 无二维码时的行为**
- ✅ **确认**: 警告后允许用户选择
- **原因**: 考虑拍摄角度、二维码损坏等实际场景

**问题4: 二维码格式**
- ✅ **确认**: 完整URL格式 `http://192.168.1.4:10000/{business_id}`
- **示例**: `http://192.168.1.4:10000/2372677039643688969`

**问题5: 性能考虑**
- ✅ **确认**: 需要异步处理 + 进度提示
- **原因**: 图片识别需要1-3秒,需要良好的用户体验

## 需求质量评分

### 功能清晰度 (30分): 28分
- ✅ 输入: 用户选择的图片文件
- ✅ 输出: 验证结果(通过/警告)+ 用户操作(继续/重新选择)
- ✅ 用户交互: 图片选择 → 二维码识别(进度提示) → 结果反馈 → 用户决策
- ✅ 成功标准: 图片中的URL与当前页面URL一致
- ⚠️ 边界情况: 多个二维码的处理逻辑待明确

### 技术特定性 (25分): 23分
- ✅ 集成点: 在现有图片选择流程中插入验证步骤
- ✅ 技术约束: 前端JavaScript实现,需引入二维码识别库
- ✅ 性能要求: 异步处理,1-3秒识别时间,需进度提示
- ⚠️ 具体库选择: 需明确使用哪个二维码识别库(html5-qrcode/jsQR等)

### 实现完整性 (25分): 22分
- ✅ 边界情况1: 图片无二维码 → 警告后允许选择
- ✅ 边界情况2: URL不匹配 → 警告后允许选择
- ✅ 错误处理: 识别失败、网络错误的处理
- ✅ 数据验证: URL格式验证、business_id提取
- ⚠️ 边界情况3: 图片包含多个二维码的处理逻辑未明确
- ⚠️ 兼容性: 移动端浏览器兼容性考虑

### 业务上下文 (20分): 19分
- ✅ 用户价值: 防止上传错误单据的图片,提高数据准确性
- ✅ 优先级: 中高优先级(数据准确性问题)
- ✅ 使用场景: 现场拍照上传单据凭证
- ⚠️ 业务影响: 对现有用户操作流程的影响程度未评估

## 当前质量得分: 92分

**评估结果**: ✅ 达到90分阈值,需求清晰度满足实现条件

## 最终确认的需求

### 功能描述
在用户选择图片后、点击上传按钮前,前端自动识别图片中的二维码,提取URL并与当前页面URL对比,根据验证结果提供用户友好的交互反馈。

### 详细规格

#### 1. 触发时机
- 用户在文件选择器中选择图片后
- 在图片预览列表中展示之前
- 异步处理,不阻塞UI

#### 2. 验证流程
```
用户选择图片
  ↓
显示"识别二维码中..."进度提示
  ↓
解析图片中的二维码
  ↓
提取URL并解析business_id
  ↓
对比当前页面的business_id
  ↓
展示验证结果
```

#### 3. 验证结果处理

**场景A: 验证通过** (图片URL的business_id == 页面URL的business_id)
- 行为: 直接添加到预览列表,无提示
- 视觉: 图片正常展示

**场景B: URL不匹配** (图片URL的business_id != 页面URL的business_id)
- 行为: 弹出警告对话框
- 消息: "检测到图片二维码与当前单据不一致<br>图片二维码: {detected_url}<br>当前单据: {current_url}<br>是否继续上传?"
- 按钮:
  - "重新拍照" → 移除该图片,重新打开文件选择器
  - "仍然上传" → 添加到预览列表,标记为警告状态(黄色边框)

**场景C: 无二维码** (图片中识别不出二维码)
- 行为: 弹出警告对话框
- 消息: "未在图片中检测到二维码<br>建议重新拍照确保二维码清晰可见<br>是否继续上传?"
- 按钮:
  - "重新拍照" → 移除该图片,重新打开文件选择器
  - "仍然上传" → 添加到预览列表,标记为警告状态(黄色边框)

**场景D: 识别失败** (技术错误,如图片格式不支持)
- 行为: 允许继续,记录错误日志
- 提示: "二维码识别服务暂时不可用,图片将正常上传"

#### 4. 技术实现

**前端库选择**
- 推荐: `html5-qrcode` 或 `jsQR`
- 原因: 轻量级,支持移动端浏览器,MIT许可证

**性能要求**
- 单张图片识别时间: ≤3秒
- 并发处理: 单张串行处理(避免资源竞争)
- 进度提示: 识别超过0.5秒时显示加载动画

**URL解析逻辑**
```javascript
// 从二维码内容中提取business_id
// 输入: "http://192.168.1.4:10000/2372677039643688969"
// 输出: "2372677039643688969"
const extractBusinessId = (url) => {
  const match = url.match(/\/(\d+)$/);
  return match ? match[1] : null;
};
```

#### 5. 用户体验

**进度提示**
- 显示位置: 图片预览区域顶部
- 内容: "正在识别二维码... (1/3)"
- 样式: 半透明遮罩层 + 旋转loading图标

**警告标记**
- 视觉: 黄色边框 + 警告图标
- 鼠标悬停: 显示警告原因("二维码不匹配"/"无二维码")
- 上传前提示: "有{n}张图片存在警告,确认上传?"

**移动端适配**
- 对话框: 全屏模态对话框,大按钮易点击
- 进度提示: 底部toast提示
- 相机权限: 引导用户授权相机访问

#### 6. 兼容性要求
- Chrome/Safari/Firefox 最新2个主版本
- iOS Safari 14+
- Android Chrome 90+
- 不支持的浏览器: 降级为普通上传(无二维码验证)

#### 7. 安全性
- 前端验证: 仅为用户体验优化,不作为安全边界
- 后端验证: 保留现有的business_id格式验证
- 数据隐私: 二维码识别在本地浏览器完成,不上传到服务器

#### 8. 测试用例
1. 正常流程: 上传匹配的单据图片
2. 不匹配: 上传其他单据的图片,用户选择"仍然上传"
3. 不匹配: 上传其他单据的图片,用户选择"重新拍照"
4. 无二维码: 上传不含二维码的图片,用户选择"仍然上传"
5. 无二维码: 上传不含二维码的图片,用户选择"重新拍照"
6. 多图片: 批量选择多张图片,部分匹配部分不匹配
7. 识别失败: 模拟识别库异常,验证降级逻辑
8. 浏览器兼容: 在iOS和Android设备上测试

## 下一步行动
等待用户确认批准,然后进入实现阶段。
