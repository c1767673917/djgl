# 需求确认文档：异步图片上传到用友云

## 原始需求
当前项目前端上传图片到后端，后端再上传图片到用友云，此时才提示用户上传成功。希望优化用户体验，当用户上传图片到后端时就提示成功，后端静默上传图片到用友云。

## 仓库上下文影响
基于仓库扫描结果（详见 `00-repository-context.md`），当前系统具备以下特点：
- **技术栈**：FastAPI + SQLite + httpx（异步架构）
- **当前上传流程**：前端 → 后端接收 → 同步上传到用友云（3个并发） → 返回结果
- **现有功能**：批量上传、重试机制（3次）、历史记录、管理后台
- **核心文件**：`app/routes/upload.py`（上传路由）、`app/core/yonyou_client.py`（用友云客户端）

## 需求确认过程

### 第一轮：初始需求分析
**原始描述**：优化用户体验，前端上传后立即返回成功，后端异步上传到用友云

**识别的关键问题**：
1. 异步任务处理方案选择
2. 用户反馈机制设计
3. 失败处理策略
4. 数据库设计扩展
5. 现有功能兼容性

### 第二轮：交互式澄清
**提出的问题**：
1. 异步任务处理方案？
2. 用户如何知道最终上传结果？
3. 失败时的处理策略？
4. 是否需要新增数据库字段？
5. 现有功能（管理后台、历史记录）如何适配？

**用户回答**：
1. ✅ 使用 FastAPI BackgroundTasks（轻量级，无需额外依赖）
2. ✅ 记录在历史记录中，用户后续查看；同时记录在管理后台中，增加可以筛选查看失败的选项
3. ✅ 自动重试（保持当前的3次重试机制）
4. ✅ 要新增字段来追踪上传状态
5. ✅ 管理后台的查询、导出功能需要显示异步上传的状态；历史记录列表需要显示"上传中"的记录

## 需求质量评分

### 功能清晰度（30/30分）
- ✅ **清晰的输入/输出规格**（10分）
  - 输入：前端上传的图片文件
  - 输出：立即返回上传成功响应，包含记录ID
  - 后台处理：异步上传到用友云，更新状态

- ✅ **用户交互流程**（10分）
  - 用户选择图片 → 上传到后端 → 立即看到成功提示
  - 后续可在历史记录中查看最终状态（上传中/成功/失败）
  - 管理员可在后台筛选查看失败记录

- ✅ **成功标准**（10分）
  - 前端响应时间 < 1秒（不等待用友云上传）
  - 后台上传保持现有重试机制（3次）
  - 上传状态准确记录和展示

### 技术特定性（25/25分）
- ✅ **集成点明确**（10分）
  - 使用 FastAPI BackgroundTasks 处理异步上传
  - 修改 `app/routes/upload.py` 中的上传路由
  - 扩展 `app/models/upload_record.py` 数据库模型
  - 更新前端展示逻辑（历史记录、管理后台）

- ✅ **技术约束**（8分）
  - 使用现有技术栈，无需引入 Celery/Redis
  - 保持 FastAPI 异步编程模式
  - 兼容现有 SQLite 数据库（考虑并发写入）

- ✅ **性能要求**（7分）
  - 前端响应时间优化至 < 1秒
  - 后台上传保持现有并发控制（3个并发）
  - 重试机制保持不变（最多3次）

### 实现完整性（25/25分）
- ✅ **边界情况**（10分）
  - 上传中状态追踪（pending → uploading → success/failed）
  - 失败后的重试逻辑（保持现有3次重试）
  - 网络异常、Token过期等异常处理

- ✅ **错误处理**（8分）
  - 3次重试后仍失败，标记为 failed 状态
  - 记录详细的错误信息到数据库
  - 管理后台可筛选查看失败记录

- ✅ **数据验证**（7分）
  - 前端验证逻辑保持不变（文件类型、大小、数量）
  - 后端参数验证保持不变
  - 数据库约束保持不变

### 业务上下文（20/20分）
- ✅ **用户价值主张**（10分）
  - 减少用户等待时间，提升上传体验
  - 前端立即反馈，后台静默处理
  - 保持数据可追溯性（历史记录、状态查询）

- ✅ **优先级定义**（10分）
  - 核心目标：优化用户体验
  - 次要目标：保持功能完整性和数据可靠性
  - 约束：使用现有技术栈，最小化依赖

## 总质量分数：100/100分 ✅

## 最终确认的需求规格

### 功能需求

#### 1. 前端上传流程优化
- **当前流程**：前端上传 → 后端同步上传到用友云 → 返回结果（耗时3-10秒）
- **优化后流程**：
  1. 前端上传图片到后端
  2. 后端立即保存记录到数据库（状态：pending）
  3. 立即返回成功响应给前端（< 1秒）
  4. 后端使用 BackgroundTasks 异步上传到用友云
  5. 上传完成后更新数据库状态（success/failed）

#### 2. 状态追踪与展示
- **新增上传状态字段**：
  - `pending`: 已接收，等待上传
  - `uploading`: 正在上传到用友云
  - `success`: 上传成功
  - `failed`: 上传失败（3次重试后）

- **历史记录列表**：
  - 显示所有状态的记录（包括"上传中"）
  - 使用图标或颜色区分不同状态
  - 实时或定期刷新状态（可选）

- **管理后台**：
  - 查询功能：支持按状态筛选（pending/uploading/success/failed）
  - 导出功能：包含上传状态字段
  - 新增筛选器：快速查看失败记录

#### 3. 失败处理与重试
- **保持现有重试机制**：
  - 自动重试最多3次
  - Token过期自动刷新
  - 网络异常自动重试

- **失败记录**：
  - 3次重试后仍失败，标记为 `failed`
  - 记录详细错误信息（error_message字段）
  - 记录重试次数（retry_count字段）

### 技术需求

#### 1. 数据库扩展（app/models/upload_record.py）
```python
# 新增字段
upload_status: str  # pending/uploading/success/failed
retry_count: int = 0  # 重试次数
error_message: str = None  # 错误信息
yonyou_upload_started_at: datetime = None  # 开始上传时间
yonyou_upload_completed_at: datetime = None  # 上传完成时间
```

#### 2. 后端实现（app/routes/upload.py）
- 使用 `BackgroundTasks` 处理异步上传
- 立即返回响应，无需等待用友云上传
- 后台任务更新数据库状态
- 保持现有的并发控制和重试逻辑

#### 3. 前端适配
- **历史记录页面**：
  - 显示上传状态（图标/文字/颜色）
  - 可选：添加刷新按钮或自动轮询

- **管理后台**：
  - 状态筛选下拉框
  - 快速筛选失败记录的按钮
  - 导出时包含状态字段

### 非功能需求

#### 1. 性能要求
- 前端响应时间 < 1秒
- 后台上传保持现有性能（3个并发）
- 数据库写入性能（考虑SQLite并发限制）

#### 2. 可靠性要求
- 保持现有重试机制（3次）
- 异常情况下数据不丢失
- 状态追踪准确可靠

#### 3. 兼容性要求
- 使用现有技术栈（FastAPI + SQLite）
- 无需引入新依赖
- 保持现有API接口兼容（仅响应速度优化）

### 用户故事

#### 用户故事 1：快速上传体验
**作为** 移动端用户
**我想要** 上传图片后立即得到反馈
**以便** 我可以快速完成工作，无需等待

**验收标准**：
- 点击上传后1秒内看到成功提示
- 可以继续上传其他图片或关闭页面
- 后续可在历史记录中查看上传状态

#### 用户故事 2：状态可追溯
**作为** 移动端用户
**我想要** 查看我上传的图片的最终状态
**以便** 我知道哪些上传成功，哪些失败

**验收标准**：
- 历史记录列表显示所有上传记录及其状态
- 可以区分"上传中"、"成功"、"失败"状态
- 失败的记录可以查看错误原因（如果有）

#### 用户故事 3：管理后台监控
**作为** 管理员
**我想要** 筛选查看失败的上传记录
**以便** 我可以及时处理问题

**验收标准**：
- 可以按状态筛选（pending/uploading/success/failed）
- 可以快速查看所有失败记录
- 导出数据时包含状态信息

### 实现优先级

#### P0（核心功能）
1. ✅ 使用 BackgroundTasks 实现异步上传
2. ✅ 数据库扩展（新增状态字段）
3. ✅ 前端立即返回成功响应
4. ✅ 后台上传状态更新

#### P1（用户体验）
1. ✅ 历史记录显示上传状态
2. ✅ 管理后台状态筛选
3. ✅ 失败记录的错误信息展示

#### P2（可选优化）
1. ⏸️ 前端自动轮询状态更新（可后续实现）
2. ⏸️ WebSocket 实时推送（如需要可升级）
3. ⏸️ 批量重试失败记录（管理后台功能）

### 技术风险与缓解措施

#### 风险1：SQLite 并发写入限制
- **风险**：多个后台任务同时写入数据库可能导致锁定
- **缓解**：保持现有的并发控制（3个并发），监控数据库写入性能
- **后续优化**：如需要可迁移到 PostgreSQL

#### 风险2：后台任务失败未记录
- **风险**：BackgroundTasks 如果异常可能导致状态未更新
- **缓解**：使用 try-except 捕获所有异常，确保状态更新
- **监控**：添加日志记录后台任务执行情况

#### 风险3：用户关闭浏览器后状态未更新
- **风险**：前端关闭不影响后台任务，但用户可能看不到最终状态
- **缓解**：历史记录列表始终显示最新状态，用户可随时查看
- **提示**：可在前端添加提示"上传正在后台处理，请稍后查看历史记录"

## 与现有代码库的集成

### 修改的文件（预估）
1. `app/models/upload_record.py` - 数据库模型扩展
2. `app/routes/upload.py` - 上传路由改造（使用 BackgroundTasks）
3. `app/routes/admin.py` - 管理后台筛选功能
4. `frontend/index.html` - 历史记录状态展示
5. `frontend/admin.html` - 管理后台状态筛选
6. `alembic/versions/xxx_add_upload_status.py` - 数据库迁移脚本（新增）

### 遵循的现有约定
1. ✅ 使用 FastAPI 异步编程模式
2. ✅ 使用 httpx 进行HTTP请求
3. ✅ 使用 Pydantic 进行数据验证
4. ✅ 使用 pytest 进行测试
5. ✅ 保持代码模块化和职责分离

### 集成测试点
1. 前端上传 → 后端立即返回（响应时间测试）
2. 后台任务执行 → 状态更新（异步任务测试）
3. 失败重试 → 最终状态记录（重试机制测试）
4. 管理后台筛选 → 正确展示（功能测试）
5. 并发上传 → 数据库一致性（并发测试）

## 总结

本需求已经过充分澄清和确认，质量分数达到 **100/100分**，满足以下标准：
- ✅ 功能清晰度：输入/输出、用户交互、成功标准明确
- ✅ 技术特定性：集成点、技术约束、性能要求清晰
- ✅ 实现完整性：边界情况、错误处理、数据验证完备
- ✅ 业务上下文：用户价值、优先级定义明确

**下一步**：等待用户批准后，进入实施阶段（Phase 2）。
